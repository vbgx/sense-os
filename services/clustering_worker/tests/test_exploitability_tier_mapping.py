from __future__ import annotations

from domain.scoring.exploitability import ExploitabilityInputs, compute_exploitability, ExploitabilityTier


def _base_inputs():
    return ExploitabilityInputs(
        severity_score=50,
        recurrence_score=50,
        monetizability_score=50,
        breakout_score=50,
        opportunity_window_score=50,
        half_life_days=180,
        contradiction_score=0,
        competitive_heat_score=0,
        saturation_score=0,
    )


def test_tier_mapping_boundaries_complete():
    # Directly craft outcomes by manipulating only one dimension at a time is hard.
    # So we assert tier mapping by overriding the resulting score using controlled inputs.

    # IGNORE: ensure very low PS/TS and high risk
    r_ignore = compute_exploitability(
        ExploitabilityInputs(
            severity_score=0,
            recurrence_score=0,
            monetizability_score=0,
            breakout_score=0,
            opportunity_window_score=0,
            half_life_days=0,
            contradiction_score=100,
            competitive_heat_score=100,
            saturation_score=100,
        )
    )
    assert r_ignore.exploitability_score < 40
    assert r_ignore.exploitability_tier == ExploitabilityTier.IGNORE

    # MONITOR: mid score band (40–59)
    r_monitor = compute_exploitability(
        ExploitabilityInputs(
            severity_score=60,
            recurrence_score=55,
            monetizability_score=55,
            breakout_score=40,
            opportunity_window_score=40,
            half_life_days=90,
            contradiction_score=30,
            competitive_heat_score=30,
            saturation_score=30,
        )
    )
    assert 40 <= r_monitor.exploitability_score <= 59
    assert r_monitor.exploitability_tier == ExploitabilityTier.MONITOR

    # INVESTIGATE: (60–79)
    r_investigate = compute_exploitability(
        ExploitabilityInputs(
            severity_score=75,
            recurrence_score=70,
            monetizability_score=70,
            breakout_score=65,
            opportunity_window_score=65,
            half_life_days=180,
            contradiction_score=20,
            competitive_heat_score=20,
            saturation_score=20,
        )
    )
    assert 60 <= r_investigate.exploitability_score <= 79
    assert r_investigate.exploitability_tier == ExploitabilityTier.INVESTIGATE

    # STRONG_BUILD: >= 80
    r_strong = compute_exploitability(
        ExploitabilityInputs(
            severity_score=95,
            recurrence_score=90,
            monetizability_score=95,
            breakout_score=85,
            opportunity_window_score=85,
            half_life_days=240,
            contradiction_score=5,
            competitive_heat_score=5,
            saturation_score=5,
        )
    )
    assert r_strong.exploitability_score >= 80
    assert r_strong.exploitability_tier == ExploitabilityTier.STRONG_BUILD
