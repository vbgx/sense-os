from __future__ import annotations

from dataclasses import dataclass

from domain.scoring.exploitability import ExploitabilityInputs, compute_exploitability
from db.repos.exploitability import ExploitabilityPersistPayload, persist_cluster_exploitability


@dataclass(frozen=True)
class ClusterMetricsForExploitability:
    # EPIC 01
    severity_score: int
    recurrence_score: int
    monetizability_score: int

    # EPIC 02
    breakout_score: int
    opportunity_window_score: int
    half_life_days: float | None

    # Risks
    contradiction_score: int
    competitive_heat_score: int
    saturation_score: int


def compute_and_persist_exploitability(
    *,
    session,
    cluster_id: str,
    m: ClusterMetricsForExploitability,
) -> None:
    r = compute_exploitability(
        ExploitabilityInputs(
            severity_score=m.severity_score,
            recurrence_score=m.recurrence_score,
            monetizability_score=m.monetizability_score,
            breakout_score=m.breakout_score,
            opportunity_window_score=m.opportunity_window_score,
            half_life_days=m.half_life_days,
            contradiction_score=m.contradiction_score,
            competitive_heat_score=m.competitive_heat_score,
            saturation_score=m.saturation_score,
        )
    )

    persist_cluster_exploitability(
        session,
        cluster_id=cluster_id,
        payload=ExploitabilityPersistPayload(
            exploitability_score=r.exploitability_score,
            exploitability_pain_strength=r.breakdown.pain_strength,
            exploitability_timing_strength=r.breakdown.timing_strength,
            exploitability_risk_penalty=r.breakdown.risk_penalty,
            exploitability_version=r.exploitability_version,
        ),
    )
