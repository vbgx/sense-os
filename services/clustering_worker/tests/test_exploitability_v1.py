from __future__ import annotations

from domain.scoring.exploitability import ExploitabilityInputs, compute_exploitability, ExploitabilityTier


def test_exploitability_ideal_case_scores_high():
    r = compute_exploitability(
        ExploitabilityInputs(
            severity_score=90,
            recurrence_score=85,
            monetizability_score=90,
            breakout_score=85,
            opportunity_window_score=80,
            half_life_days=200,
            contradiction_score=10,
            competitive_heat_score=15,
            saturation_score=10,
        )
    )
    assert r.exploitability_score > 80
    assert r.exploitability_tier == ExploitabilityTier.STRONG_BUILD
    assert r.exploitability_version == "exploitability_v1"


def test_exploitability_weak_and_saturated_scores_low():
    r = compute_exploitability(
        ExploitabilityInputs(
            severity_score=25,
            recurrence_score=20,
            monetizability_score=15,
            breakout_score=10,
            opportunity_window_score=20,
            half_life_days=5,
            contradiction_score=60,
            competitive_heat_score=80,
            saturation_score=85,
        )
    )
    assert r.exploitability_score < 40
    assert r.exploitability_tier == ExploitabilityTier.IGNORE


def test_exploitability_bounded_and_stable_on_rerun():
    inputs = ExploitabilityInputs(
        severity_score=999,
        recurrence_score=-10,
        monetizability_score=500,
        breakout_score=1000,
        opportunity_window_score=-200,
        half_life_days=9999,
        contradiction_score=999,
        competitive_heat_score=999,
        saturation_score=999,
    )
    r1 = compute_exploitability(inputs)
    r2 = compute_exploitability(inputs)
    assert 0 <= r1.exploitability_score <= 100
    assert r1.exploitability_score == r2.exploitability_score
    assert r1.exploitability_tier == r2.exploitability_tier


def test_half_life_null_defaults_to_neutral_50():
    r = compute_exploitability(
        ExploitabilityInputs(
            severity_score=50,
            recurrence_score=50,
            monetizability_score=50,
            breakout_score=50,
            opportunity_window_score=50,
            half_life_days=None,
            contradiction_score=0,
            competitive_heat_score=0,
            saturation_score=0,
        )
    )
    assert r.breakdown.half_life_normalized == 50
