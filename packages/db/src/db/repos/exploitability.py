from __future__ import annotations

from dataclasses import dataclass
from typing import Optional

from sqlalchemy import update
from sqlalchemy.orm import Session

from db.models import PainCluster


@dataclass(frozen=True)
class ExploitabilityPersistPayload:
    exploitability_score: int
    exploitability_pain_strength: float
    exploitability_timing_strength: float
    exploitability_risk_penalty: float
    exploitability_version: str


def persist_cluster_exploitability(
    session: Session,
    *,
    cluster_id: str,
    payload: ExploitabilityPersistPayload,
) -> None:
    """
    Persist exploitability fields on pain_clusters.

    Deterministic: caller owns scoring version + breakdown.
    """
    stmt = (
        update(PainCluster)
        .where(PainCluster.id == cluster_id)
        .values(
            exploitability_score=int(payload.exploitability_score),
            exploitability_pain_strength=float(payload.exploitability_pain_strength),
            exploitability_timing_strength=float(payload.exploitability_timing_strength),
            exploitability_risk_penalty=float(payload.exploitability_risk_penalty),
            exploitability_version=str(payload.exploitability_version),
        )
    )
    session.execute(stmt)
