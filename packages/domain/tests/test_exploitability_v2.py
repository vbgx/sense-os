from domain.scoring.exploitability import ExploitabilityInputs, compute_exploitability
from domain.scoring.exploitability_v2 import compute_exploitability_v2


def test_saturated_market_reduces_score():
    inputs = ExploitabilityInputs(
        severity_score=70,
        recurrence_score=70,
        monetizability_score=70,
        breakout_score=60,
        opportunity_window_score=60,
        half_life_days=120.0,
        contradiction_score=10,
        competitive_heat_score=70,
        saturation_score=70,
    )

    v1 = compute_exploitability(inputs)

    v2, _ = compute_exploitability_v2(
        inputs,
        competitive_density_score=90,
        ph_overlap_score=90,
        repo_density_score=90,
        keyword_saturation_score=90,
    )

    assert v2.exploitability_score <= v1.exploitability_score


def test_niche_market_increases_score():
    inputs = ExploitabilityInputs(
        severity_score=70,
        recurrence_score=70,
        monetizability_score=70,
        breakout_score=60,
        opportunity_window_score=60,
        half_life_days=120.0,
        contradiction_score=10,
        competitive_heat_score=10,
        saturation_score=10,
    )

    v1 = compute_exploitability(inputs)

    v2, _ = compute_exploitability_v2(
        inputs,
        competitive_density_score=10,
        ph_overlap_score=10,
        repo_density_score=10,
        keyword_saturation_score=10,
    )

    assert v2.exploitability_score >= v1.exploitability_score


def test_stable_between_runs():
    inputs = ExploitabilityInputs(
        severity_score=50,
        recurrence_score=50,
        monetizability_score=50,
        breakout_score=50,
        opportunity_window_score=50,
        half_life_days=50.0,
        contradiction_score=20,
        competitive_heat_score=20,
        saturation_score=20,
    )

    v2a, ba = compute_exploitability_v2(
        inputs,
        competitive_density_score=40,
        ph_overlap_score=30,
        repo_density_score=20,
        keyword_saturation_score=10,
    )
    v2b, bb = compute_exploitability_v2(
        inputs,
        competitive_density_score=40,
        ph_overlap_score=30,
        repo_density_score=20,
        keyword_saturation_score=10,
    )

    assert v2a.exploitability_score == v2b.exploitability_score
    assert ba.underserved_factor == bb.underserved_factor
    assert ba.underserved_multiplier == bb.underserved_multiplier
