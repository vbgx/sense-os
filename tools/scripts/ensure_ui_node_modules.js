const fs = require("fs");
const path = require("path");

const root = path.resolve(__dirname, "..", "..");
const appsNodeModules = path.join(root, "apps", "node_modules");
const webNodeModules = path.join(root, "apps", "web", "node_modules");

const packages = ["tailwindcss", "tw-animate-css"];

fs.mkdirSync(appsNodeModules, { recursive: true });

for (const pkg of packages) {
  const target = path.join(webNodeModules, pkg);
  const link = path.join(appsNodeModules, pkg);

  if (!fs.existsSync(target)) {
    // eslint-disable-next-line no-console
    console.warn(`ensure_ui_node_modules: missing ${target}`);
    continue;
  }

  try {
    const stat = fs.lstatSync(link);
    if (stat.isSymbolicLink() || stat.isDirectory()) continue;
  } catch (err) {
    // ignore and create link
  }

  try {
    fs.rmSync(link, { recursive: true, force: true });
  } catch (err) {
    // ignore
  }

  const type = process.platform === "win32" ? "junction" : "dir";
  fs.symlinkSync(target, link, type);
}
